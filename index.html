<!DOCTYPE html>

<html>

    <head>

        <title>Coms</title>

        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <!-- Adds buttons that don't refresh the page-->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
        
        <script>

            $(document).ready(function() {

                var ws
                
                console.log("DOG READY");
                
                function append_text(text) {
                    var box = document.getElementById("box")
                    box.innerHTML = box.innerHTML + text + "<br>"
                }

                function connect_ws(url) {
                    return new Promise( resolve =>
                    {
                        ws = new WebSocket(url);

                        ws.addEventListener("open", event => {
                            console.log("Connected to WS server!");
                            resolve();
                        });

                        ws.addEventListener("message", ( {data} ) => {
                            var message = JSON.parse(data)
                            console.log("WS server says: ",  message);

                            append_text(`<b>${message.name}</b>: ${message.message}`)
                        });
                    });
                }

                
                
                document.getElementById("address").addEventListener("submit", event => {
                    var address = $("form#address input").val();

                    if (ws == null || address != ws.url) {
                        append_text("<i>Connecting..</i>")
                        
                        try {
                            connect_ws(address)
                            append_text("<i>Connected!</i>")
                        } catch {
                            append_text("<i>Connection failed.</i>")
                        }
                        
                    } else {
                        append_text("<i>Already connected</i>")
                    }

                    
                })

                $("form#name").submit(function (event) {
                    return false;
                })
                    
                $("form#address").submit(function (event) {
                    return false;
                })

                $("form#msg").submit(function (event) {

                    var name = $("form#name input").val()
                    if (ws == null) {
                        append_text("<i>You need to connect to a server first</i>")
                        return false;
                    }
                    if (name == "") {
                        append_text("<i>Enter a name</i>")
                        return false;
                    }

                    var message = $("form#msg input").val();
                    $("form#msg input").val("");

                    obj = {"message": message, "name": name}
                    console.log(`Submit \"${message}\" to ${ws.url}`)
                    ws.send(JSON.stringify(obj))

                    return false;
                })

            })

        </script>

    </head>

    <body>

        <div style="position: fixed; min-height: 10%;">
            <form id="address">
                <label for="a">Server Address</label>
                <input type="text" id="a">
            </form>
            
            <form id="name">
                <label for="n">Username</label>
                <input type="text" id="n">
            </form>

            <form id="msg">
                <label for="m">Message Content</label>
                <input type="text" id="m">
                <input type="submit" value="Send">
            </form>
        </div>

        <br>
        <br>
        <br>
        <br>

        <div id="box">

        </div>
        

    </body>


</html>
